#!/usr/bin/env bash

# This file will be checked separately
# shellcheck disable=SC1091
. bin/lib/toolbox.sh

pandoc() {
  command pandoc -o "${2%.*}.$1" -f markdown -t "$1" -s --toc \
    "${extra_args[@]}" "$2"
}

md2html() {
  local extra_args=()
  pandoc html "$@"
}

md2pdf() {
  pandoc pdf "$@"
}

deps=(grep pandoc) local_deps=(tput) ci_deps=()

if is_ci; then
  deps+=("${ci_deps[@]}")
else
  deps+=("${local_deps[@]}")
fi

for dep in "${deps[@]}"; do
  if ! has "$dep"; then
    WANTS_COLORS=no die "%s is a required dependency" "$dep"
  fi
done

if ! compgen -e | grep -qFx WANTS_COLORS; then
  export WANTS_COLORS=yes
fi

for file do
  info "processing file %s" "$file"

  if [[ ! -r $file ]]; then
    error "unable to load file %s" "$file"
    continue
  fi

  if ! md2html "$file"; then
    die "file %s could not be converted to html" "$file"
  fi

  info "generated html build of file %s" "$file"
  
  if ! md2pdf "$file"; then
    die "file %s could not be converted to pdf" "$file"
  fi

  info "generated pdf build of file %s" "$file"
done
