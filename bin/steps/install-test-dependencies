#!/usr/bin/env bash

# These files will be checked individually.
# shellcheck disable=SC1091
. bin/lib/util.sh
. bin/lib/log.sh

needed_pkgs=(shellcheck)

# The os type is determined in a separate module.
# shellcheck disable=SC2154
if [[ $os = darwin ]]; then
  if ! has brew; then
    die "Please install brew before continuing.\n"
  fi

  install_cmd=(brew install)
elif [[ $os = linux ]]; then
  # Assume Ubuntu for the moment.
  install_cmd=(apt install -y)

  # Install the typos-cli utility.
  api_root=https://api.github.com
  api_pkg=$api_root/repos/crate-ci/typos/releases/latest

  dld_url=$(curl -sS "$api_pkg" | jq -rM '
    .assets[] |
    select(.browser_download_url | contains("linux")) |
    .browser_download_url
  ')

  if [[ -z $dld_url ]]; then
    die "unable to find suitable release for package %s" "$pkg"
  fi

  curl -sSLo /tmp/typos-cli.tar.gz "$dld_url"
  mkdir -p /tmp/typos-cli
  tar -C /tmp/typos-cli -xf /tmp/typos-cli.tar.gz

  find /tmp/typos-cli -type f -name typos \
    -exec sh -c '[ -x "$1" ]' _ {} ';' \
    -exec sh -c 'cp -f "$1" /usr/local/bin' _ {} ';' \
    -quit
fi

for pkg in "${needed_pkgs[@]}"; do
  if ! has "$pkg"; then
    pkgs+=("$pkg")
  fi
done

if (( ${#pkgs[@]} )); then
  "${install_cmd[@]}" "${pkgs[@]}"
fi
